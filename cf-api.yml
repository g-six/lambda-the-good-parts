AWSTemplateFormatVersion: 2010-09-09
Description: Deploy User API to Lambda

Resources:
    Kastle:
        Type: AWS::ApiGateway::RestApi
        Properties:
            Name: Kastle

    KastleResource:
        Type: 'AWS::ApiGateway::Resource'
        Properties:
            ParentId: !GetAtt Kastle.RootResourceId
            RestApiId: !Ref Kastle
            PathPart: '{proxy+}'

    KastleResourceAny:
        Type: AWS::ApiGateway::Method
        Properties:
            RestApiId: !Ref Kastle
            ResourceId: !Ref KastleResource
            HttpMethod: ANY
            AuthorizationType: NONE
            Integration:
                Type: AWS_PROXY
                IntegrationHttpMethod: POST
                Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaUserApi.Arn}/invocations

    LambdaUserApi:
        Type: AWS::Lambda::Function
        Properties:
            Handler: index.userApi
            Role: !GetAtt LambdaExecutionRole.Arn
            Runtime: nodejs8.10
            Code:
                S3Bucket: kastle-lambda-functions
                S3Key: users-api.zip
    LambdaExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: Allow
                      Principal:
                          Service:
                              - lambda.amazonaws.com
                      Action:
                          - sts:AssumeRole
            Path: '/'
            Policies:
                - PolicyName: root
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Effect: Allow
                            Action:
                                - logs:*
                            Resource: arn:aws:logs:*:*:*

    Deployment:
        DependsOn:
            - LambdaExecutionRole
            - LambdaUserApi
            - Kastle
            - KastleResource
            - KastleResourceAny
        Type: AWS::ApiGateway::Deployment
        Properties:
            RestApiId: !Ref Kastle
            StageName: test
